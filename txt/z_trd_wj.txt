z_trd_wj1:--z_trd_wj1
declare @t_mon nvarchar(10)
declare @t_bcustno nvarchar(20)
declare @t_ecustno nvarchar(20)
set @t_mon = case when '#non'=[2] then '' else [2] end
set @t_bcustno = case when '#non'=[3] then '' else [3] end
set @t_ecustno = case when '#non'=[4] then char(255) else [4] end
declare @tmp table(
  gno nvarchar(1),
  trdnoa nvarchar(100),
  recno int,
  rr int,
  custno nvarchar(100),
  cust nvarchar(100),
  boss nvarchar(100),
  tel nvarchar(100),
  fax nvarchar(100),
  serial nvarchar(100),
  yy nvarchar(10),
  mm nvarchar(10),
  invoiceno nvarchar(100),
  
  trandate nvarchar(100),
  datea nvarchar(100),
  carno nvarchar(100),
  straddr nvarchar(max),
  endaddr nvarchar(max),
  nick nvarchar(100),
  product nvarchar(100),
  mount nvarchar(30),
  weight nvarchar(30),
  weight2 nvarchar(30),
  noa nvarchar(50),
  price float,
  total float,
  cost float,--人工裝卸費
  total2 float,
  total3 float,
  cartype nvarchar(50),
  tranno nvarchar(50),
  typea nvarchar(50),
  range nvarchar(100),
  total4 float,--自運金額
  total5 float,--外車金額
  cost2 float,--管理收入
  tax  float,
  total6 float
)
insert into @tmp 
select '0',a.noa,'',ROW_NUMBER()over(partition by c.po order by c.po,c.datea),a.custno,a.comp,e.boss,e.tel,e.fax,e.serial,
SUBSTRING(a.datea,1,3),SUBSTRING(a.datea,5,2),a.vccano,c.trandate,c.datea,c.carno
,b.straddr,addr2
,c.endaddr,b.product,b.mount,d.uweight,c.weight,c.po
,b.price,b.total,c.price2,b.total+c.price2,'',case when f.cartype='2' or f.cartype='6' then '自' else '外' end
,d.tranno,d.typea,cast(g.rate as nvarchar(50))+'T~'+cast(g.rate2 as nvarchar(50))+'T','','',c.price3,'',''
from view_trd a
left join view_trds b on a.noa = b.noa
left join view_trans c on b.tranno=c.noa and b.trannoq=c.noq
left join view_tranvcces106 d on c.ordeno=d.noa and c.so=d.noq
left join cust e on a.custno=e.noa
left join car2 f on c.carno=f.noa
left join addr2s g on c.straddrno=g.noa and c.price=g.value and d.typea=g.carno
where left(a.datea,6)=@t_mon and a.custno between @t_bcustno and @t_ecustno

update @tmp
set recno=b.rx,total3=b.total2,total4=case when a.cartype='自' then b.total2 else '' end,total5=case when a.cartype='外' then b.total2 else '' end
from @tmp a
outer apply(select ROW_NUMBER()over(partition by gno order by noa)rx,recno,noa,SUM(total2)total2 from @tmp group by noa,gno,recno)b
where a.noa=b.noa

update @tmp
set gno=case when rr=1 then 0 else 1 end 

insert @tmp(gno,noa,custno,total,total2,total3,tax,total4,total5,total6)
select '2',CHAR(255),custno,SUM(total),SUM(total2),SUM(total3),SUM(total3)*0.05,SUM(total4),SUM(total5),SUM(total3)*1.05
from @tmp
group by custno

insert @tmp(gno,noa,custno)
select '3',CHAR(255),custno
from @tmp
group by custno

select 
RIGHT(datea,5)datea
,dbo.getComma(total,0)total
,dbo.getComma(total2,0)total2
,dbo.getComma(total3,0)total3
,dbo.getComma(total4,0)total4
,dbo.getComma(total5,0)total5
,dbo.getComma(total6,0)total6
,dbo.getComma(tax,0)tax
,dbo.getComma(cost,0)cost
,dbo.getComma(cost2,0)cost2
,* from @tmp order by noa,recno,rr;